#!/bin/sh
set -eu

if git rev-parse --verify HEAD >/dev/null 2>&1
then
	against=HEAD
else
	against=$(git hash-object -t tree /dev/null)
fi

if [ ! -f ./.venv/bin/activate ]; then
    echo "Missing .venv/ (run: make venv)" >&2
    exit 1
fi
. ./.venv/bin/activate

make lint
make test

exec git diff-index --check --cached "$against" --
